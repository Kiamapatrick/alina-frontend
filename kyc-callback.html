<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Verifying Identity — Alina 906 Vibes</title>
  <link rel="stylesheet" href="css/kyc-luxury.css" />
</head>

<body>

  <div class="kyc-wrap">

    <div class="kyc-brand">
      <a href="index.html">Alina<span>906</span>Vibes</a>
    </div>

    <!-- ── Pending state ── -->
    <div id="pendingState" class="kyc-card">

      <div class="kyc-icon kyc-icon--pending">
        <svg viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" />
          <path stroke-linecap="round" d="M12 6v6l4 2" />
        </svg>
      </div>

      <span class="kyc-eyebrow">Processing</span>
      <h1>Verifying your<br><em>identity.</em></h1>

      <p class="kyc-message">
        Our system is reviewing your documents. This typically takes 1–3 minutes.
      </p>

      <div class="kyc-spinner"></div>
      <p class="kyc-spinner-text" id="spinnerLabel">Analyzing documents&hellip;</p>

      <div class="kyc-rule"></div>

      <span class="kyc-section-label">Good to know</span>
      <ul class="kyc-list">
        <li>
          <svg viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span>You can safely close this page — we'll email you once verification is complete</span>
        </li>
        <li>
          <svg viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span>Most verifications complete within <strong>2 minutes</strong></span>
        </li>
      </ul>

    </div>

    <!-- ── Verified state ── -->
    <div id="verifiedState" class="kyc-card hidden">

      <div class="kyc-icon kyc-icon--success">
        <svg viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
        </svg>
      </div>

      <span class="kyc-eyebrow">Identity Verified</span>
      <h1>You're in.<br><em>Welcome.</em></h1>

      <p class="kyc-message">
        Your identity has been successfully confirmed. You now have full access to all Alina 906 Vibes features.
      </p>

      <div class="kyc-rule"></div>

      <span class="kyc-section-label">What's next</span>
      <ul class="kyc-list">
        <li>
          <svg viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
          </svg>
          <span>Explore available properties and book your perfect stay</span>
        </li>
        <li>
          <svg viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span>Instant wallet-connected payments, fully on-chain</span>
        </li>
      </ul>

      <p class="kyc-countdown">
        Redirecting in <strong><span id="countdown">5</span></strong> seconds
      </p>

      <div class="kyc-actions">
        <button class="kyc-btn kyc-btn--primary" id="continueBtn">Continue to Platform</button>
      </div>

    </div>

    <!-- ── Rejected state ── -->
    <div id="rejectedState" class="kyc-card hidden">

      <div class="kyc-icon kyc-icon--error">
        <svg viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </div>

      <span class="kyc-eyebrow">Verification Unsuccessful</span>
      <h1>We couldn't<br><em>confirm you.</em></h1>

      <p class="kyc-message" id="rejectedSubtitle">
        We weren't able to verify your identity at this time. You can try again with clearer documents.
      </p>

      <div class="kyc-rule"></div>

      <ul class="kyc-list" id="rejectedReasons">
        <li>
          <svg viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
          </svg>
          <span>Photos were blurry, overexposed, or too dark to read</span>
        </li>
        <li>
          <svg viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <span>ID document was expired or edges were cut off</span>
        </li>
        <li>
          <svg viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          <span>Information didn't match between your documents and selfie</span>
        </li>
      </ul>

      <div class="kyc-actions">
        <a href="kyc-start.html" class="kyc-btn kyc-btn--primary">Try Again</a>
        <a href="contact.html" class="kyc-btn kyc-btn--ghost">Contact Support</a>
      </div>

    </div>

  </div>

  <script>
    const API_BASE = 'https://alina906vibes-backend.onrender.com';
    const POLL_INTERVAL = 3000;
    const MAX_POLLS = 100;

    let pollCount = 0;
    let countdownInterval;

    const urlParams = new URLSearchParams(window.location.search);
    let userId = urlParams.get('uid') || urlParams.get('referenceId') || localStorage.getItem('userId');

    if (!userId || userId === 'undefined') {
      const token = localStorage.getItem('authToken');
      if (token) {
        try {
          const payload = JSON.parse(atob(token.split('.')[1]));
          userId = payload.id;
        } catch (e) { console.error('JWT decode failed', e); }
      }
    }

    if (!userId || userId === 'undefined') {
      window.location.href = '/login.html';
    }

    const states = {
      pending: document.getElementById('pendingState'),
      verified: document.getElementById('verifiedState'),
      rejected: document.getElementById('rejectedState')
    };

    function showState(state) {
      Object.values(states).forEach(el => el.classList.add('hidden'));
      states[state].classList.remove('hidden');
    }

    // Animate spinner label cycling
    const spinnerLabels = [
      'Analyzing documents\u2026',
      'Cross-referencing data\u2026',
      'Running biometric check\u2026',
      'Almost there\u2026'
    ];
    let labelIdx = 0;
    const spinnerLabel = document.getElementById('spinnerLabel');
    setInterval(() => {
      labelIdx = (labelIdx + 1) % spinnerLabels.length;
      spinnerLabel.style.opacity = '0';
      setTimeout(() => {
        spinnerLabel.textContent = spinnerLabels[labelIdx];
        spinnerLabel.style.opacity = '1';
      }, 200);
    }, 3500);
    spinnerLabel.style.transition = 'opacity 0.2s ease';

    function startRedirectCountdown(seconds = 5) {
      const el = document.getElementById('countdown');
      let remaining = seconds;
      if (el) el.textContent = remaining;
      countdownInterval = setInterval(() => {
        remaining--;
        if (el) el.textContent = remaining;
        if (remaining <= 0) {
          clearInterval(countdownInterval);
          redirectToHome();
        }
      }, 1000);
    }

    function redirectToHome() {
      window.location.href = localStorage.getItem('authToken') ? '/index.html' : '/login.html';
    }

    async function checkKycStatus() {
      try {
        const token = localStorage.getItem('authToken');
        if (!token) throw new Error('No auth token');

        const response = await fetch(`${API_BASE}/api/auth/kyc-status/${userId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) throw new Error('Fetch failed');

        const data = await response.json();
        const status = (data.kycStatus || '').toLowerCase();

        if (['approved', 'verified', 'success'].includes(status)) {
          showState('verified');
          startRedirectCountdown(5);
          document.getElementById('continueBtn').onclick = () => {
            clearInterval(countdownInterval);
            redirectToHome();
          };
          return true;
        }

        if (['rejected', 'declined', 'failed'].includes(status)) {
          showState('rejected');
          return true;
        }

        if (status === 'resubmission_required' || status.includes('resubmit')) {
          document.getElementById('rejectedSubtitle').textContent =
            'We need clearer documentation to complete your verification. Please retry with better-quality images.';
          showState('rejected');
          return true;
        }

        pollCount++;
        if (pollCount >= MAX_POLLS) { showState('rejected'); return true; }
        return false;

      } catch (err) {
        console.error(err);
        pollCount++;
        if (pollCount >= MAX_POLLS) { showState('rejected'); return true; }
        return false;
      }
    }

    async function startPolling() {
      const stop = await checkKycStatus();
      if (!stop) setTimeout(startPolling, POLL_INTERVAL);
    }

    startPolling();

    window.addEventListener('beforeunload', () => {
      if (countdownInterval) clearInterval(countdownInterval);
    });
  </script>

</body>

</html>