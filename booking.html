<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Booking ‚Äî Alina906Vibes</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />
  <link rel="stylesheet" href="css/booking2.css" />
  <link rel="stylesheet" href="css/new.css" />
  

</head>
<body>



<!-- Status Message (Fixed Position) -->
<div id="bookingStatus"></div>

<header class="py-3 border-bottom">
  <div class="container d-flex flex-wrap align-items-center justify-content-between">
    <div class="brand fw-bold fs-4">Alina906Vibes</div>

    <nav class="d-flex flex-wrap align-items-center gap-2">
      <a href="index.html" class="nav-link text-dark">Home</a>
      <a href="about.html" class="nav-link text-dark">About</a>
      <a href="contact.html" class="nav-link text-dark">Contact</a>
      <a id="loginLink" href="login.html" class="btn btn-outline-success ms-3">Sign In</a>
      <a id="signupLink" href="signup.html" class="btn btn-success ms-2">Sign Up</a>
    </nav>

<div class="wallet-controls-wrapper">
  <!-- Connect button (hidden after connect) -->
  <button id="connectWallet" class="btn-wallet-connect">
    <span class="wallet-icon">ü¶ä</span>
    <span class="wallet-btn-text">Connect Wallet</span>
  </button>

  <!-- Shown after connect, hidden by default -->
  <div id="walletInfoRow" class="wallet-info-row" style="display:none;">
    <div class="wallet-badge">
      <span class="wallet-dot"></span>
      <span id="walletAddress" class="wallet-addr">‚Äî</span>
    </div>
    <button id="disconnectWallet" class="btn-wallet-disconnect">
      Disconnect
    </button>
  </div>

  <button id="logoutBtn" class="btn btn-logout">Logout</button>
</div>
  </div>
</header>

<main class="booking-container">
  <section class="rental-header mb-3">
    <h1 id="rentalTitle">Loading...</h1>
    <p id="rentalDescription" class="text-muted"></p>
  </section>

  <section class="row g-4 align-items-start">
    <div class="col-lg-7">
      <!-- Image Gallery -->
      <div class="gallery-section mb-3">
        <div id="rentalGallery" class="gallery-grid border rounded overflow-hidden">
          <!-- Images will be injected here dynamically -->
        </div>
      </div>
      <section class="unit-details mb-4">
  <h4 class="mb-2">About this unit</h4>
  <p id="unitLongDescription" class="text-muted">
    Comfortable, fully furnished unit ideal for short and long stays.
  </p>

  <div class="row mt-3">
    <div class="col-md-6">
      <h6>Amenities</h6>
      <ul id="unitAmenities" class="list-unstyled small">
        <li>‚úî Free Wi-Fi</li>
        <li>‚úî Smart TV</li>
        <li>‚úî Fully equipped kitchen</li>
        <li>‚úî Hot shower</li>
      </ul>
    </div>

    <div class="col-md-6">
      <h6>Location</h6>
      <p id="unitLocation" class="small text-muted">
        Kilimani, Nairobi, 5 minutes from Yaya Centre.
      </p>
    </div>
  </div>
</section>


      <div class="booking-display mb-3">
        <h5>Availability</h5>

        <div id="calendarContainer" class="border rounded p-3 bg-light">
          <div id="calendar-header" class="d-flex justify-content-between align-items-center mb-2">
            <button id="prevMonth" class="btn btn-outline-secondary btn-sm">‚Äπ</button>
            <h5 id="monthYear" class="m-0 fw-bold"></h5>
            <button id="nextMonth" class="btn btn-outline-secondary btn-sm">‚Ä∫</button>
          </div>

          <div class="calendar-grid text-center">
            <div class="calendar-weekday fw-bold">Mon</div>
            <div class="calendar-weekday fw-bold">Tue</div>
            <div class="calendar-weekday fw-bold">Wed</div>
            <div class="calendar-weekday fw-bold">Thu</div>
            <div class="calendar-weekday fw-bold">Fri</div>
            <div class="calendar-weekday fw-bold">Sat</div>
            <div class="calendar-weekday fw-bold">Sun</div>
          </div>

          <div id="calendar" class="calendar-grid mt-2"></div>
        </div>
      </div>
      <section class="unit-reviews mb-4">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h4 class="mb-0">Guest Reviews</h4>
    <span class="badge bg-success">4.8 ‚òÖ</span>
  </div>

  <div id="reviewsList" class="vstack gap-3">
    <div class="border rounded p-3">
      <div class="d-flex justify-content-between">
        <strong>James K.</strong>
        <span class="text-warning small">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
      </div>
      <p class="mb-0 small text-muted">
        Clean, secure, and exactly as advertised. Smooth check-in.
      </p>
    </div>

    <div class="border rounded p-3">
      <div class="d-flex justify-content-between">
        <strong>Linda M.</strong>
        <span class="text-warning small">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</span>
      </div>
      <p class="mb-0 small text-muted">
        Great location and responsive host. Would book again.
      </p>
    </div>
  </div>
</section>

    </div>

<aside class="col-lg-5">
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <h5 class="card-title">Booking</h5>

      <!-- Price info -->
      <p class="mb-2">
        Price per night:
        <strong id="unitPrice">KES 3,500</strong>
      </p>

      <!-- Booking form -->
      <form id="bookingForm" novalidate>
        <!-- Dates -->
        <div class="mb-2">
          <label for="startDate" class="form-label small">Check-in</label>
          <input id="startDate" class="form-control" type="date" required />
        </div>

        <div class="mb-3">
          <label for="endDate" class="form-label small">Check-out</label>
          <input id="endDate" class="form-control" type="date" required />
        </div>

        <!-- Booking summary -->
        <div class="border rounded p-2 mb-3">
          <div class="d-flex justify-content-between small">
            <span>Nights</span>
            <strong id="totalNights">0</strong>
          </div>

          <div class="d-flex justify-content-between small">
            <span>Full Amount</span>
            <strong id="fullAmount">KES 0</strong>
          </div>

          <div class="d-flex justify-content-between small">
            <span>Deposit</span>
            <strong id="depositAmount">KES 500</strong>
          </div>

          <div class="d-flex justify-content-between small">
            <span>Balance</span>
            <strong id="balanceAmount">KES 0</strong>
          </div>
        </div>

        <!-- Payment options -->
        <div class="mb-3">
          <label class="form-label small">Payment Option</label>

          <div class="form-check border rounded p-2 mb-2">
            <input
              class="form-check-input"
              type="radio"
              name="paymentType"
              id="payFull"
              value="FULL"
            />
            <label class="form-check-label" for="payFull">
              Pay Full Amount
              <div class="small text-muted">
                Pay <span id="fullAmountLabel">KES 0</span> now
              </div>
            </label>
          </div>

          <div class="form-check border rounded p-2">
            <input
              class="form-check-input"
              type="radio"
              name="paymentType"
              id="payDeposit"
              value="DEPOSIT"
              checked
            />
            <label class="form-check-label" for="payDeposit">
              Pay Deposit
              <div class="small text-muted">
                Pay KES 500 now, balance before check-in
              </div>
            </label>
          </div>
        </div>

        <!-- Guest phone -->
        <div class="mb-3">
          <label for="guestPhone" class="form-label small">
            Guest Phone Number (for access code)
          </label>
          <input
            type="tel"
            id="guestPhone"
            class="form-control"
            placeholder="254712345678"
            required
          />
          <div class="form-text">
            Access code will be sent on check-in day.
          </div>
        </div>
        <div class="mb-3" id="emailFieldWrapper">
  <label for="guestEmail" class="form-label small">
    Email Address
  </label>
  <input
    type="email"
    id="guestEmail"
    class="form-control"
    placeholder="your@email.com"
  />
  <div class="form-text">
    Required for card payments.
  </div>
</div>

<!-- Payment method -->
<div class="mb-3">
  <label for="paymentMethod" class="form-label small">
    Payment Method
  </label>
  <select id="paymentMethod" class="form-select">
    <option value="mpesa">M-Pesa</option>
    <option value="visa">Card (Visa/Mastercard via Paystack)</option>
    <option value="crypto">Crypto (Wallet)</option>
  </select>
</div>

        <!-- M-Pesa phone -->
        <div class="mb-3" id="mpesaFieldWrapper">
          <label for="mpesaPhone" class="form-label small">
            M-Pesa Phone Number
          </label>
          <input
            type="tel"
            id="mpesaPhone"
            class="form-control"
            placeholder="254712345678"
            pattern="254(7|1)[0-9]{8}"
          />
          <div class="form-text">
            You will receive the M-Pesa prompt on this number.
          </div>
        </div>

        <!-- Pay button -->
        <div class="d-grid">
          <button
            id="bookBtn"
            type="button"
            class="btn btn-success"
          >
            Pay KES 0
          </button>
        </div>
<div id="balancePaymentContainer" class="mb-3" style="display: none;">
  <h6>Pending Balance</h6>
  <p class="small text-muted">You have a pending balance of <strong id="pendingBalance">KES 0</strong></p>
  <div class="d-grid">
    <button id="payBalanceBtn" class="btn btn-warning">Pay Balance</button>
  </div>
</div>

      </form>
    </div>
  </div>

  <!-- User bookings -->
<div id="userBookings" class="mb-3">
  <h6>Your Bookings</h6>
  <div class="bookings-search mb-2">
    <input type="text" id="bookingSearch" placeholder="Search bookings..." class="form-control">
  </div>
  <div id="bookingsContent" class="bookings-content">
    <div id="bookingsList" class="bookings-list">
      <!-- JS will inject booking cards here -->
    </div>
  </div>
</div>

</aside>

  </section>
</main>

<!-- Transaction Cooldown Alert -->
<div id="txCooldown" style="display: none;">
  <div class="alert mb-0">
    ‚è±Ô∏è Please wait <span id="cooldownTimer">10</span> seconds before next transaction
  </div>
</div>

<footer class="text-center py-4 border-top">
  <small>¬© 2025 Alina906Vibes</small>
</footer>

<script type="module">


/* ===============================
   URL + UNIT
================================ */
const urlParams = new URLSearchParams(window.location.search);
const unitId = urlParams.get("id");
const BASE_URL = "https://alina906vibes-backend.onrender.com";
/* ===============================
   UI HELPERS
================================ */
window.showLoading = function (show = true) {
  const overlay = document.getElementById("loadingOverlay");
  if (overlay) overlay.classList.toggle("active", show);
};

window._statusTimeout = null;

window.showStatus = function (msg, type = "info") {
  const statusEl = document.getElementById("bookingStatus");
  if (!statusEl) return;

  if (window._statusTimeout) {
    clearTimeout(window._statusTimeout);
    window._statusTimeout = null;
  }

  // Reset classes
  statusEl.classList.remove("show", "text-danger", "text-success", "text-muted");
  statusEl.textContent = msg;

  // Force reflow so removing .show actually resets the transition
  void statusEl.offsetHeight;

  if (type === "error") statusEl.classList.add("text-danger");
  else if (type === "success") statusEl.classList.add("text-success");
  else statusEl.classList.add("text-muted");

  statusEl.classList.add("show");

  window._statusTimeout = setTimeout(() => {
    statusEl.classList.remove("show");
    window._statusTimeout = null;
  }, type === "success" ? 5000 : 7000);
};
/* ===============================
   LOAD RENTAL DETAILS
================================ */
async function loadRentalDetails(incomingId) {
  const id = incomingId || unitId;
  if (!id) {
    document.getElementById("rentalTitle").textContent = "Unit not specified";
    return;
  }

  try {
    showLoading(true);

    const BASE_URL = "https://alina906vibes-backend.onrender.com";
    const res = await fetch(`${BASE_URL}/units/${id}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const unit = await res.json();

    document.body.dataset.unitId = id;

    document.getElementById("rentalTitle").textContent =
      unit.name || "Rental Unit";

    document.getElementById("rentalDescription").textContent =
      unit.description || "";

    document.getElementById("unitLongDescription").textContent =
      unit.longDescription || unit.description || "";

    document.getElementById("unitLocation").textContent =
      unit.location || "Location not specified";

    document.getElementById("unitPrice").textContent =
      `$${unit.pricePerNight || 35}/night`;

    renderGallery(unit);
    renderAmenities(unit.amenities);

  } catch (err) {
    console.error("Failed to load unit:", err);
    document.getElementById("rentalTitle").textContent = "Failed to load unit";
    showStatus("Failed to load rental details", "error");
  } finally {
    showLoading(false);
  }
}

/* ===============================
   GALLERY RENDERING
================================ */
function renderGallery(unit) {
  const gallery = document.getElementById("rentalGallery");
  if (!gallery) return;

  gallery.innerHTML = "";

  const images = [];

  if (unit.image) {
    if (typeof unit.image === "string" && unit.image.includes(",")) {
      unit.image.split(",").map(s => s.trim()).forEach(i => images.push(i));
    } else {
      images.push(unit.image);
    }
  }

  if (!images.length) {
    const img = document.createElement("img");
    img.src = "/img/placeholder.jpg";
    img.alt = "No image available";
    gallery.appendChild(img);
    return;
  }

  images.forEach(path => {
    let src = path;
    if (!path.startsWith("http") && !path.startsWith("/")) {
      src = path.startsWith("img/") ? `/${path}` : `/img/${path}`;
    }
    const img = document.createElement("img");
    img.src = src;
    img.alt = unit.name || "Unit image";
    gallery.appendChild(img);
  });
}

/* ===============================
   AMENITIES RENDERING
================================ */
function renderAmenities(amenities = []) {
  const amenitiesEl = document.getElementById("unitAmenities");
  if (!amenitiesEl) return;

  amenitiesEl.innerHTML = "";

  if (!Array.isArray(amenities) || !amenities.length) {
    amenitiesEl.innerHTML = "<li>No amenities listed</li>";
    return;
  }

  amenities.forEach(item => {
    const li = document.createElement("li");
    li.textContent = `‚úî ${item}`;
    amenitiesEl.appendChild(li);
  });
}

/* ===============================
   PHONE HELPERS
================================ */
function normalizeKenyanPhone(input) {
  if (!input) return null;

  let phone = input.replace(/\s+/g, "");

  if (phone.startsWith("0")) phone = "+254" + phone.slice(1);
  else if (phone.startsWith("254")) phone = "+" + phone;
  else if (phone.startsWith("7")) phone = "+254" + phone;

  return phone;
}

function isValidKenyanPhone(phone) {
  return /^\+2547\d{8}$/.test(phone);
}

/* ===============================
   DOM READY
================================ */
document.addEventListener("DOMContentLoaded", () => {
  loadRentalDetails();

  // Existing payment method toggle logic
  const paymentSelect = document.getElementById("paymentMethod");
  const mpesaWrapper = document.getElementById("mpesaFieldWrapper");
  const emailWrapper = document.getElementById("emailFieldWrapper"); // ADD THIS


  paymentSelect.addEventListener("change", e => {
    mpesaWrapper.classList.toggle("hidden", e.target.value !== "mpesa");
     emailWrapper.classList.toggle("hidden", e.target.value !== "visa"); // ADD THIS

  });
  if (paymentSelect.value !== "mpesa") mpesaWrapper.classList.add("hidden");
  if (paymentSelect.value !== "visa") emailWrapper.classList.add("hidden"); // ADD THIS









  /* ===============================
     BOOKING ACTION
  =============================== */
  document.getElementById("bookBtn").addEventListener("click", async () => {
    const rawGuestPhone = document.getElementById("guestPhone").value;
    const guestPhone = normalizeKenyanPhone(rawGuestPhone);

    if (!guestPhone || !isValidKenyanPhone(guestPhone)) {
      showStatus("Enter a valid phone number (07XXXXXXXX)", "error");
      return;
    }

    let phoneNumber = guestPhone;

    if (paymentSelect.value === "mpesa") {
      const rawMpesaPhone = document.getElementById("mpesaPhone").value;
      const mpesaPhone = normalizeKenyanPhone(rawMpesaPhone);

      if (!mpesaPhone || !isValidKenyanPhone(mpesaPhone)) {
        showStatus("Enter a valid M-Pesa phone number", "error");
        return;
      }

      phoneNumber = mpesaPhone;
    }

    console.log("Booking phone number:", phoneNumber);
    // proceed with booking API
  });
});
</script>


<script src="js/nav.js"></script>
<script type="module" src="js/booking.js"></script>

</body>
</html>